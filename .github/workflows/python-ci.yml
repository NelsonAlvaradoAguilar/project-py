name: Python CI - Feature New

on:
  push:
    branches:
      - feature/new # Trigger on feature branch
  pull_request:
    branches:
      - develop # Optional for PRs to develop

jobs:
  test-and-merge:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest

      - name: Auto merge feature/new into develop
        if: success() && github.ref == 'refs/heads/feature/new'
        uses: devops-infra/action-pull-request@v0.5.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: feature/new
          target_branch: develop
          pr_title: "Auto merge feature/new → develop"
          pr_body: "This PR was created automatically after passing tests."

      - name: Run tests on develop → main PR
        if: success() && github.ref == 'refs/heads/develop'
        run: |
          echo "Tests passed on develop. Ready to merge into main."

      - name: Auto merge develop into main
        if: success() && github.ref == 'refs/heads/develop'
        uses: devops-infra/action-pull-request@v0.5.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: develop
          target_branch: main
          pr_title: "Auto merge develop → main"
          pr_body: "This PR was created automatically after passing tests."
